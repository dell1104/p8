{% extends "base_sidebar.html" %}

{% block title %}Panel de Administraci√≥n - Sistema Forense{% endblock %}

{% block page_title %}
<div class="d-flex justify-content-between align-items-center">
    <span>Panel de Administraci√≥n</span>
    <div class="d-flex gap-2">
        <span class="text-muted">Hola, {{ current_user.username }}</span>
        <a href="{{ url_for('auth.logout') }}" class="btn btn-outline-danger btn-sm">
            <i class="fas fa-sign-out-alt me-1"></i>Cerrar Sesi√≥n
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1">
                        <i class="fas fa-cog me-2 text-primary"></i>Panel de Administraci√≥n
                    </h1>
                    <p class="text-muted mb-0 small">Gestionar usuarios, casos y configuraci√≥n del sistema</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Gesti√≥n de Usuarios -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card fade-in-up">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-users me-2"></i>Gesti√≥n de Usuarios
                    </h4>
                </div>
                <div class="card-body">
                    <!-- Crear Usuario -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5 class="text-primary mb-3">
                                <i class="fas fa-user-plus me-2"></i>Crear Nuevo Usuario
                            </h5>
                            <form id="userForm">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="username" class="form-label">Usuario *</label>
                                        <input type="text" class="form-control" id="username" name="username" autocomplete="username" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="email" class="form-label">Email *</label>
                                        <input type="email" class="form-control" id="email" name="email" autocomplete="email" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="nombreCompleto" class="form-label">Nombre Completo *</label>
                                        <input type="text" class="form-control" id="nombreCompleto" name="nombreCompleto" autocomplete="name" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="rol" class="form-label">Rol *</label>
                                        <select class="form-select" id="rol" name="rol" autocomplete="off" required>
                                    <option value="usuario">Usuario</option>
                                    <option value="admin">Administrador</option>
                                </select>
                            </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="password" class="form-label">Contrase√±a *</label>
                                        <input type="password" class="form-control" id="password" name="password" autocomplete="new-password" required>
                        </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="confirmPassword" class="form-label">Confirmar Contrase√±a *</label>
                                        <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" autocomplete="new-password" required>
                            </div>
                                    <div class="col-12 mb-3">
                                        <label for="apiKey" class="form-label">Clave API AssemblyAI (opcional)</label>
                                        <input type="text" class="form-control" id="apiKey" name="apiKey" autocomplete="off" placeholder="Ingrese la clave API de AssemblyAI">
                                        <div class="form-text">Se usar√° para transcripci√≥n de audios</div>
                            </div>
                                    <div class="col-12">
                                        <button type="submit" class="btn btn-success">
                                            <i class="fas fa-user-plus me-1"></i>Crear Usuario
                                        </button>
                        </div>
                            </div>
                    </form>
                        </div>
                </div>

                <!-- Lista de Usuarios -->
                    <div class="row">
                        <div class="col-12">
                            <h5 class="text-primary mb-3">
                                <i class="fas fa-list me-2"></i>Usuarios del Sistema
                            </h5>
                            <div class="table-responsive">
                                <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Usuario</th>
                                    <th>Email</th>
                                    <th>Nombre Completo</th>
                                    <th>Rol</th>
                                    <th>Estado</th>
                                    <th>Fecha Creaci√≥n</th>
                                    <th>√öltimo Acceso</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                        <tr>
                                            <td>1</td>
                                            <td>admin</td>
                                            <td>admin@sistema.com</td>
                                            <td>Administrador del Sistema</td>
                                            <td><span class="badge bg-primary">admin</span></td>
                                            <td><span class="badge bg-success">Activo</span></td>
                                            <td>9/9/2025, 15:27:42</td>
                                            <td>9/9/2025, 17:30:09</td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary" onclick="editarUsuario(1)">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-warning" onclick="cambiarEstado(1)">
                                                    <i class="fas fa-toggle-on"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger" onclick="eliminarUsuario(1)">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

            <!-- Gesti√≥n de Casos -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card fade-in-up">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-folder-open me-2"></i>Gesti√≥n de Casos
                    </h4>
                </div>
                <div class="card-body">
                    <!-- Acciones -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="d-flex gap-2 mb-3">
                                <button class="btn btn-primary" onclick="cargarCasos()">
                                    <i class="fas fa-sync me-1"></i>Cargar Todos los Casos
                                </button>
                                <button class="btn btn-warning" onclick="debugCasos()">
                                    <i class="fas fa-bug me-1"></i>Debug Casos
                                </button>
                                <button class="btn btn-outline-primary" onclick="exportarCSV()">
                                    <i class="fas fa-download me-1"></i>Exportar a CSV
                                </button>
                                <button class="btn btn-outline-warning" onclick="actualizacionMasiva()">
                                    <i class="fas fa-tools me-1"></i>Actualizaci√≥n Masiva
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Filtros -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="fas fa-filter me-2"></i>Filtros de B√∫squeda
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-3 mb-2">
                                            <label for="estadoFiltro" class="form-label">Estado:</label>
                                            <select class="form-select" id="estadoFiltro" autocomplete="off">
                                    <option value="">Todos</option>
                                                <option value="activo">Activo</option>
                                                <option value="completado">Completado</option>
                                                <option value="archivado">Archivado</option>
                                </select>
                            </div>
                                        <div class="col-md-3 mb-2">
                                            <label for="expedienteFiltro" class="form-label">Expediente:</label>
                                            <input type="text" class="form-control" id="expedienteFiltro" autocomplete="off" placeholder="Buscar por expediente...">
                            </div>
                                        <div class="col-md-3 mb-2">
                                            <label for="fechaDesde" class="form-label">Desde:</label>
                                            <input type="date" class="form-control" id="fechaDesde" autocomplete="off">
                            </div>
                                        <div class="col-md-3 mb-2">
                                            <label for="fechaHasta" class="form-label">Hasta:</label>
                                            <input type="date" class="form-control" id="fechaHasta" autocomplete="off">
                            </div>
                        </div>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-primary" onclick="aplicarFiltros()">
                                            <i class="fas fa-search me-1"></i>Aplicar Filtros
                                        </button>
                                        <button class="btn btn-outline-secondary" onclick="limpiarFiltros()">
                                            <i class="fas fa-eraser me-1"></i>Limpiar
                                        </button>
                                    </div>
                                </div>
                            </div>
                    </div>
                </div>

                    <!-- Lista de Casos -->
                    <div class="row">
                        <div class="col-12">
                            <div class="table-responsive">
                                <table class="table table-striped">
                            <thead>
                                <tr>
                                            <th>ID Expediente</th>
                                    <th>Nombre Caso</th>
                                    <th>Informe T√©cnico</th>
                                    <th>Estado</th>
                                    <th>Fecha Creaci√≥n</th>
                                    <th>Fecha Intervenci√≥n</th>
                                    <th>Origen</th>
                                    <th>Archivos</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                                    <tbody id="casosTableBody">
                                <tr>
                                            <td colspan="9" class="text-center text-muted py-4">
                                                Haga clic en "Cargar Todos los Casos" para ver la informaci√≥n
                                            </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                            </div>
                            </div>
                            </div>
                        </div>
                    </div>

    <!-- Estad√≠sticas y Logs -->
    <div class="row">
        <!-- Estad√≠sticas Avanzadas -->
        <div class="col-12">
            <div class="card fade-in-up mb-4">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                            <i class="fas fa-chart-line me-2"></i>Estad√≠sticas Avanzadas
                    </h5>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-primary btn-sm" onclick="cambiarMes(-1)">
                                <i class="fas fa-chevron-left"></i> Mes Anterior
                            </button>
                            <span class="btn btn-primary btn-sm" id="mesActual">Enero 2025</span>
                            <button class="btn btn-outline-primary btn-sm" onclick="cambiarMes(1)">
                                Mes Siguiente <i class="fas fa-chevron-right"></i>
                            </button>
                            <button class="btn btn-success btn-sm" onclick="exportarEstadisticas()">
                                <i class="fas fa-download"></i> Exportar CSV
                            </button>
                        </div>
                    </div>
                        </div>
                <div class="card-body">
                    <!-- Estad√≠sticas Generales del Mes -->
                    <div class="row mb-4">
                        <div class="col-md-3 mb-3">
                            <div class="stats-item bg-primary text-white">
                                <h6>Total Casos del Mes</h6>
                                <h3 id="totalCasosMes">-</h3>
                    </div>
                </div>
                        <div class="col-md-3 mb-3">
                            <div class="stats-item bg-warning text-white">
                                <h6>Casos Activos</h6>
                                <h3 id="casosActivosMes">-</h3>
                        </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="stats-item bg-success text-white">
                                <h6>Casos Completados</h6>
                                <h3 id="casosCompletadosMes">-</h3>
                        </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="stats-item bg-info text-white">
                                <h6>% Completado</h6>
                                <h3 id="porcentajeCompletado">-</h3>
                        </div>
                    </div>
                    </div>
                    
                    <!-- An√°lisis por Tipo de Requerimiento -->
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0"><i class="fas fa-tasks me-2"></i>Por Tipo de Requerimiento</h6>
                                </div>
                                <div class="card-body">
                                    <div id="tiposRequerimiento" class="table-responsive">
                                        <!-- Se llenar√° din√°micamente -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0"><i class="fas fa-building me-2"></i>Por Origen de Solicitud</h6>
                                </div>
                                <div class="card-body">
                                    <div id="origenesSolicitud" class="table-responsive">
                                        <!-- Se llenar√° din√°micamente -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Gr√°fico Hist√≥rico -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0"><i class="fas fa-chart-area me-2"></i>Evoluci√≥n Hist√≥rica (√öltimos 12 Meses)</h6>
                                </div>
                                <div class="card-body">
                                    <canvas id="graficoHistorico" width="400" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Botones de Acci√≥n -->
                    <div class="d-flex gap-2 mt-3">
                        <button class="btn btn-outline-primary btn-sm" onclick="actualizarEstadisticasAvanzadas()">
                            <i class="fas fa-sync me-1"></i>Actualizar
                        </button>
                        <button class="btn btn-outline-warning btn-sm" onclick="crearBackup()">
                            <i class="fas fa-database me-1"></i>Backup
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="limpiarDatos()">
                            <i class="fas fa-trash me-1"></i>Limpiar
                        </button>
                        <a href="{{ url_for('auth.logout') }}" class="btn btn-danger btn-sm">
                            <i class="fas fa-sign-out-alt me-1"></i>Cerrar Sesi√≥n
                        </a>
                    </div>
                        </div>
                    </div>
                </div>
                
        <!-- Logs del Sistema -->
        <div class="col-md-6">
            <div class="card fade-in-up">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-file-alt me-2"></i>Logs del Sistema
                    </h5>
                        </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="row">
                            <div class="col-6">
                                <select class="form-select form-select-sm" id="nivelLog">
                                    <option value="">Todos</option>
                                    <option value="ERROR">Error</option>
                                    <option value="WARNING">Advertencia</option>
                                    <option value="INFO">Informaci√≥n</option>
                    </select>
                </div>
                            <div class="col-6">
                                <input type="date" class="form-control form-control-sm" id="fechaLog">
                </div>
                </div>
                </div>
                    <div class="logs-container" style="max-height: 200px; overflow-y: auto;">
                        <div class="log-entry">
                            <small class="text-muted">5/1/2025, 19:30:00</small>
                            <span class="badge bg-info ms-2">INFO</span>
                            <span class="ms-2">Sistema iniciado correctamente</span>
                </div>
        </div>
                    <div class="d-flex gap-2 mt-3">
                        <button class="btn btn-outline-primary btn-sm" onclick="actualizarLogs()">
                            <i class="fas fa-sync me-1"></i>Actualizar
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="exportarLogs()">
                            <i class="fas fa-download me-1"></i>Exportar
                        </button>
    </div>
            </div>
            </div>
            </div>
        </div>
    </div>

    <!-- Modal para Ver Caso -->
    <div id="viewCaseModal" class="modal" style="display: none;">
        <div class="modal-content modal-centered">
            <span class="close" onclick="closeViewModal()">&times;</span>
            <h2>üëÅÔ∏è Ver Caso</h2>
            <div id="caseDetails" class="case-details">
                <!-- Los detalles del caso se cargar√°n aqu√≠ -->
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeViewModal()">‚ùå Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Caso -->
    <div id="editCaseModal" class="modal" style="display: none;">
        <div class="modal-content modal-centered">
            <span class="close" onclick="closeEditCaseModal()">&times;</span>
            <h2>‚úèÔ∏è Editar Caso</h2>
            <form id="editCaseForm" class="admin-form">
                <input type="hidden" id="editCaseId" name="id">
                <div class="form-row">
                    <div class="form-group">
                        <label for="editCaseExpediente">Expediente:</label>
                        <input type="text" id="editCaseExpediente" name="expediente" required>
                    </div>
                    <div class="form-group">
                        <label for="editCaseNombre">Nombre del Caso:</label>
                        <input type="text" id="editCaseNombre" name="nombre_caso" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="editCaseInforme">Informe T√©cnico:</label>
                        <input type="text" id="editCaseInforme" name="numero_informe_tecnico">
                    </div>
                    <div class="form-group">
                        <label for="editCaseEstado">Estado:</label>
                        <select id="editCaseEstado" name="estado_caso" required>
                            <option value="En Proceso">En Proceso</option>
                            <option value="Completado">Completado</option>
                            <option value="Archivado">Archivado</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="editCaseFechaIntervencion">Fecha Intervenci√≥n:</label>
                        <input type="date" id="editCaseFechaIntervencion" name="fecha_intervencion">
                    </div>
                    <div class="form-group">
                        <label for="editCaseHoraIntervencion">Hora Intervenci√≥n:</label>
                        <input type="time" id="editCaseHoraIntervencion" name="hora_intervencion">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="editCaseOrigen">Origen Solicitud:</label>
                        <input type="text" id="editCaseOrigen" name="origen_solicitud">
                    </div>
                    <div class="form-group">
                        <label for="editCaseTipo">Tipo Requerimiento:</label>
                        <input type="text" id="editCaseTipo" name="tipo_requerimiento">
                    </div>
                </div>
                <div class="form-group">
                    <label for="editCaseObservaciones">Observaciones:</label>
                    <textarea id="editCaseObservaciones" name="observaciones" rows="3"></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-success">‚úÖ Guardar Cambios</button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditCaseModal()">‚ùå Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Confirmar Eliminaci√≥n -->
    <div id="deleteConfirmModal" class="modal" style="display: none;">
        <div class="modal-content modal-centered modal-small">
            <div class="delete-modal-header">
                <i class="fas fa-exclamation-triangle"></i>
                <h2>‚ö†Ô∏è Confirmar Eliminaci√≥n</h2>
            </div>
            <div class="delete-modal-body">
                <p>¬øEst√°s seguro de que quieres eliminar este caso?</p>
                <div class="case-info" id="deleteCaseInfo">
                    <!-- La informaci√≥n del caso se cargar√° aqu√≠ -->
                </div>
                <p class="warning-text">Esta acci√≥n no se puede deshacer y eliminar√° todos los archivos asociados.</p>
            </div>
            <div class="delete-modal-actions">
                <button class="btn btn-danger" onclick="confirmDeleteCase()">
                    <i class="fas fa-trash"></i> Eliminar Definitivamente
                </button>
                <button class="btn btn-secondary" onclick="closeDeleteModal()">
                    <i class="fas fa-times"></i> Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Resultado de Eliminaci√≥n -->
    <div id="deleteResultModal" class="modal" style="display: none;">
        <div class="modal-content modal-centered modal-small">
            <div class="result-modal-header" id="resultModalHeader">
                <!-- Se llenar√° din√°micamente -->
            </div>
            <div class="result-modal-body">
                <p id="resultMessage"></p>
            </div>
            <div class="result-modal-actions">
                <button class="btn btn-primary" onclick="closeResultModal()">
                    <i class="fas fa-check"></i> Entendido
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Resultado de Usuarios -->
    <div id="userResultModal" class="modal" style="display: none;">
        <div class="modal-content modal-centered modal-small">
            <div class="result-modal-header" id="userResultModalHeader">
                <!-- Se llenar√° din√°micamente -->
            </div>
            <div class="result-modal-body">
                <p id="userResultMessage"></p>
            </div>
            <div class="result-modal-actions">
                <button class="btn btn-primary" onclick="closeUserResultModal()">
                    <i class="fas fa-check"></i> Entendido
                </button>
            </div>
        </div>
    </div>

    <script>
// Funciones del panel de administraci√≥n
document.getElementById('userForm').addEventListener('submit', async function(e) {
            e.preventDefault();
    
    const formData = new FormData(this);
    const password = formData.get('password');
    const confirmPassword = formData.get('confirmPassword');
    
    if (password !== confirmPassword) {
        alert('Las contrase√±as no coinciden');
        return;
    }
    
    try {
        const response = await fetch('/api/crear-usuario', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                username: formData.get('username'),
                email: formData.get('email'),
                nombre_completo: formData.get('nombreCompleto'),
                rol: formData.get('rol'),
                password: password,
                assemblyai_key: formData.get('apiKey') || null
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showUserResult('success', '¬°Usuario Creado Exitosamente!', 'El usuario ha sido creado correctamente y ya puede iniciar sesi√≥n en el sistema.');
            this.reset();
            cargarUsuarios();
        } else {
            showUserResult('error', 'Error al Crear Usuario', data.error);
        }
    } catch (error) {
        showUserResult('error', 'Error de Conexi√≥n', 'No se pudo conectar con el servidor: ' + error.message);
    }
});

async function cargarCasos() {
    try {
        // Mostrar indicador de carga
        const casosTableBody = document.getElementById('casosTableBody');
        casosTableBody.innerHTML = `
            <tr>
                <td colspan="9" class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="mt-2 text-muted">Cargando casos...</p>
                </td>
            </tr>
        `;
        
        const response = await fetch('/api/casos_completos');
        console.log('üì° Respuesta de la API:', response.status);
        
        const result = await response.json();
        console.log('üìä Datos recibidos:', result);
        
        if (result.success) {
            currentCases = result.casos;
            console.log(`‚úÖ Casos cargados: ${result.casos.length} casos`);
            mostrarCasos(result.casos);
                } else {
            console.error('‚ùå Error en la respuesta:', result.error);
            casosTableBody.innerHTML = `
                <tr>
                    <td colspan="9" class="text-center">
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>Error: ${result.error}
                </div>
                    </td>
                </tr>
            `;
                }
            } catch (error) {
        document.getElementById('casosTableBody').innerHTML = `
            <tr>
                <td colspan="9" class="text-center">
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>Error de conexi√≥n: ${error.message}
            </div>
                </td>
            </tr>
        `;
    }
}

function mostrarCasos(casos) {
    const casosTableBody = document.getElementById('casosTableBody');
    
    if (casos.length === 0) {
        casosTableBody.innerHTML = `
            <tr>
                <td colspan="9" class="text-center py-4">
                <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
                <p class="text-muted">No hay casos registrados</p>
                </td>
            </tr>
        `;
                return;
            }
            
    let html = '';
    casos.forEach(caso => {
        html += `
            <tr>
                <td>${caso.id}</td>
                <td>${caso.expediente || 'N/A'}</td>
                <td>${caso.nombre_caso || 'N/A'}</td>
                <td>${caso.numero_informe_tecnico || 'N/A'}</td>
                <td><span class="badge bg-primary">${caso.estado_caso || 'N/A'}</span></td>
                <td>${caso.fecha_creacion ? new Date(caso.fecha_creacion).toLocaleDateString() : 'N/A'}</td>
                <td>${caso.fecha_intervencion || 'N/A'}</td>
                <td>${caso.origen_solicitud || 'N/A'}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="verCaso(${caso.id})" title="Ver">
                                <i class="fas fa-eye"></i>
                            </button>
                    <button class="btn btn-sm btn-outline-warning" onclick="editarCaso(${caso.id})" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="eliminarCaso(${caso.id})" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                </td>
            </tr>
        `;
    });
    
    casosTableBody.innerHTML = html;
}

async function verCaso(caseId) {
    try {
        const caso = currentCases.find(c => c.id === caseId);
        if (!caso) {
            alert('Caso no encontrado');
            return;
        }

        const details = document.getElementById('caseDetails');
        details.innerHTML = `
            <div class="case-detail-grid">
                <div class="detail-section">
                    <h4>üìã Informaci√≥n B√°sica</h4>
                    <p><strong>ID:</strong> ${caso.id}</p>
                    <p><strong>Expediente:</strong> ${caso.expediente || 'N/A'}</p>
                    <p><strong>Nombre del Caso:</strong> ${caso.nombre_caso || 'N/A'}</p>
                    <p><strong>Informe T√©cnico:</strong> ${caso.numero_informe_tecnico || 'N/A'}</p>
                    <p><strong>Estado:</strong> <span class="badge bg-primary">${caso.estado_caso || 'N/A'}</span></p>
                    </div>
                <div class="detail-section">
                    <h4>üìÖ Fechas</h4>
                    <p><strong>Fecha Creaci√≥n:</strong> ${caso.fecha_creacion ? new Date(caso.fecha_creacion).toLocaleDateString() : 'N/A'}</p>
                    <p><strong>Fecha Intervenci√≥n:</strong> ${caso.fecha_intervencion || 'N/A'}</p>
                    <p><strong>Hora Intervenci√≥n:</strong> ${caso.hora_intervencion || 'N/A'}</p>
                        </div>
                <div class="detail-section">
                    <h4>üè¢ Origen y Tipo</h4>
                    <p><strong>Origen Solicitud:</strong> ${caso.origen_solicitud || 'N/A'}</p>
                    <p><strong>Tipo Requerimiento:</strong> ${caso.tipo_requerimiento || 'N/A'}</p>
                </div>
                <div class="detail-section">
                    <h4>üìù Observaciones</h4>
                    <p>${caso.observaciones || 'Sin observaciones'}</p>
                </div>
                <div class="detail-section">
                    <h4>üîó Informaci√≥n T√©cnica</h4>
                    <p><strong>Sesi√≥n ID:</strong> ${caso.sesion_id}</p>
                    <p><strong>Completado:</strong> ${caso.completado ? 'S√≠' : 'No'}</p>
                        </div>
                        </div>
        `;

        document.getElementById('viewCaseModal').style.display = 'block';
    } catch (error) {
        alert('Error al cargar detalles del caso: ' + error.message);
    }
}

function editarCaso(caseId) {
    const caso = currentCases.find(c => c.id === caseId);
    if (!caso) {
        alert('Caso no encontrado');
        return;
    }

    // Llenar el formulario
    document.getElementById('editCaseId').value = caso.id;
    document.getElementById('editCaseExpediente').value = caso.expediente || '';
    document.getElementById('editCaseNombre').value = caso.nombre_caso || '';
    document.getElementById('editCaseInforme').value = caso.numero_informe_tecnico || '';
    document.getElementById('editCaseEstado').value = caso.estado_caso || 'En Proceso';
    document.getElementById('editCaseFechaIntervencion').value = caso.fecha_intervencion || '';
    document.getElementById('editCaseHoraIntervencion').value = caso.hora_intervencion || '';
    document.getElementById('editCaseOrigen').value = caso.origen_solicitud || '';
    document.getElementById('editCaseTipo').value = caso.tipo_requerimiento || '';
    document.getElementById('editCaseObservaciones').value = caso.observaciones || '';

    document.getElementById('editCaseModal').style.display = 'block';
}

// Variable global para el caso a eliminar
let currentCaseToDelete = null;

function eliminarCaso(caseId) {
    console.log('Intentando eliminar caso ID:', caseId);
    console.log('Casos disponibles:', currentCases);
    
    const caso = currentCases.find(c => c.id == caseId); // Usar == para comparaci√≥n flexible
    if (!caso) {
        showDeleteResult('error', 'Caso No Encontrado', `No se encontr√≥ el caso con ID ${caseId}. Por favor, recarga la p√°gina e int√©ntalo de nuevo.`);
        return;
    }

    console.log('Caso encontrado:', caso);
    currentCaseToDelete = caso;
    
    // Mostrar informaci√≥n del caso en el modal
    const caseInfo = document.getElementById('deleteCaseInfo');
    caseInfo.innerHTML = `
        <div class="case-summary">
            <p><strong>ID:</strong> ${caso.id}</p>
            <p><strong>Expediente:</strong> ${caso.expediente || 'N/A'}</p>
            <p><strong>Nombre:</strong> ${caso.nombre_caso || 'N/A'}</p>
            <p><strong>Estado:</strong> ${caso.estado_caso || 'N/A'}</p>
        </div>
    `;
    
    document.getElementById('deleteConfirmModal').style.display = 'block';
}

async function confirmDeleteCase() {
    if (!currentCaseToDelete) {
        showDeleteResult('error', 'Error de Sistema', 'No se encontr√≥ el caso a eliminar. Por favor, int√©ntalo de nuevo.');
        return;
    }
    
    // Guardar el ID del caso antes de cerrar el modal
    const caseId = currentCaseToDelete.id;
    const caseInfo = `${currentCaseToDelete.expediente || 'N/A'} - ${currentCaseToDelete.nombre_caso || 'N/A'}`;
    
    // Cerrar el modal de confirmaci√≥n
    closeDeleteModal();
    
    try {
        const response = await fetch(`/api/admin/delete-case/${caseId}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showDeleteResult('success', '¬°Caso Eliminado Exitosamente!', `El caso "${caseInfo}" ha sido eliminado correctamente y todos los archivos asociados han sido removidos del sistema.`);
            cargarCasos();
        } else {
            showDeleteResult('error', 'Error al Eliminar Caso', `No se pudo eliminar el caso "${caseInfo}": ${data.error}`);
        }
    } catch (error) {
        showDeleteResult('error', 'Error de Conexi√≥n', `No se pudo conectar con el servidor: ${error.message}`);
    }
}

function closeDeleteModal() {
    document.getElementById('deleteConfirmModal').style.display = 'none';
    currentCaseToDelete = null;
}

function showDeleteResult(type, title, message) {
    const header = document.getElementById('resultModalHeader');
    const messageEl = document.getElementById('resultMessage');
    
    if (type === 'success') {
        header.innerHTML = `
            <i class="fas fa-check-circle"></i>
            <h2>‚úÖ ${title}</h2>
        `;
        header.className = 'result-modal-header success-header';
    } else {
        header.innerHTML = `
            <i class="fas fa-times-circle"></i>
            <h2>‚ùå ${title}</h2>
        `;
        header.className = 'result-modal-header error-header';
    }
    
    messageEl.textContent = message;
    document.getElementById('deleteResultModal').style.display = 'block';
}

function closeResultModal() {
    document.getElementById('deleteResultModal').style.display = 'none';
}

function showUserResult(type, title, message) {
    const header = document.getElementById('userResultModalHeader');
    const messageEl = document.getElementById('userResultMessage');
    
    if (type === 'success') {
        header.innerHTML = `
            <i class="fas fa-check-circle"></i>
            <h2>‚úÖ ${title}</h2>
        `;
        header.className = 'result-modal-header success-header';
    } else {
        header.innerHTML = `
            <i class="fas fa-times-circle"></i>
            <h2>‚ùå ${title}</h2>
        `;
        header.className = 'result-modal-header error-header';
    }
    
    messageEl.textContent = message;
    document.getElementById('userResultModal').style.display = 'block';
}

function closeUserResultModal() {
    document.getElementById('userResultModal').style.display = 'none';
}

function exportarCSV() {
    alert('Exportando a CSV...');
}

function actualizacionMasiva() {
    alert('Iniciando actualizaci√≥n masiva...');
}

// Variables para casos
let currentCases = [];

function aplicarFiltros() {
    const estado = document.getElementById('estadoFiltro').value;
    const expediente = document.getElementById('expedienteFiltro').value.toLowerCase();
    const fechaDesde = document.getElementById('fechaDesde').value;
    const fechaHasta = document.getElementById('fechaHasta').value;

    let filteredCases = currentCases;

    if (estado) {
        filteredCases = filteredCases.filter(c => c.estado_caso === estado);
    }

    if (expediente) {
        filteredCases = filteredCases.filter(c => 
            (c.expediente || '').toLowerCase().includes(expediente)
        );
    }

    if (fechaDesde) {
        filteredCases = filteredCases.filter(c => 
            c.fecha_creacion && c.fecha_creacion >= fechaDesde
        );
    }

    if (fechaHasta) {
        filteredCases = filteredCases.filter(c => 
            c.fecha_creacion && c.fecha_creacion <= fechaHasta
        );
    }

    mostrarCasos(filteredCases);
    alert(`Se encontraron ${filteredCases.length} casos`);
}

function limpiarFiltros() {
    document.getElementById('estadoFiltro').value = '';
    document.getElementById('expedienteFiltro').value = '';
    document.getElementById('fechaDesde').value = '';
    document.getElementById('fechaHasta').value = '';
    mostrarCasos(currentCases);
}

// Variables globales
let currentUsers = [];
let currentCases = [];
let currentCaseToDelete = null;
let currentYear = new Date().getFullYear();
let currentMonth = new Date().getMonth() + 1;

// Cargar datos al inicializar
document.addEventListener('DOMContentLoaded', function() {
    cargarUsuarios();
    actualizarEstadisticas();
    actualizarEstadisticasAvanzadas();
});

// Cargar usuarios
async function cargarUsuarios() {
    try {
        const response = await fetch('/api/usuarios');
        const data = await response.json();
        
        if (data.success) {
            currentUsers = data.usuarios;
            mostrarUsuarios(data.usuarios);
        } else {
            alert('Error al cargar usuarios: ' + data.error);
        }
    } catch (error) {
        alert('Error al cargar usuarios: ' + error.message);
    }
}

// Mostrar usuarios en la tabla
function mostrarUsuarios(usuarios) {
    const tbody = document.getElementById('usersTableBody');
    tbody.innerHTML = '';

    usuarios.forEach(user => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${user.id}</td>
            <td>${user.username}</td>
            <td>${user.email}</td>
            <td>${user.nombre_completo}</td>
            <td><span class="badge bg-primary">${user.rol}</span></td>
            <td><span class="badge ${user.activo ? 'bg-success' : 'bg-danger'}">${user.activo ? 'Activo' : 'Inactivo'}</span></td>
            <td>${user.fecha_creacion ? new Date(user.fecha_creacion).toLocaleDateString() : 'N/A'}</td>
            <td>${user.ultimo_acceso ? new Date(user.ultimo_acceso).toLocaleDateString() : 'Nunca'}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="editarUsuario(${user.id})" title="Editar">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-outline-warning" onclick="cambiarEstado(${user.id})" title="Cambiar Estado">
                    <i class="fas fa-toggle-on"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="eliminarUsuario(${user.id})" title="Eliminar" ${user.rol === 'admin' ? 'disabled' : ''}>
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function editarUsuario(id) {
    const user = currentUsers.find(u => u.id === id);
    if (!user) return;
    
    // Llenar el formulario con los datos del usuario
    document.getElementById('username').value = user.username;
    document.getElementById('email').value = user.email;
    document.getElementById('nombreCompleto').value = user.nombre_completo;
    document.getElementById('rol').value = user.rol;
    document.getElementById('apiKey').value = user.assemblyai_key || '';
    
    // Cambiar el bot√≥n para actualizar
    const submitBtn = document.querySelector('#userForm button[type="submit"]');
    submitBtn.innerHTML = '<i class="fas fa-save me-1"></i>Actualizar Usuario';
    submitBtn.onclick = () => actualizarUsuario(id);
}

async function actualizarUsuario(id) {
    const formData = new FormData(document.getElementById('userForm'));
    const password = formData.get('password');
    
    try {
        const response = await fetch(`/api/actualizar-usuario/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                username: formData.get('username'),
                email: formData.get('email'),
                nombre_completo: formData.get('nombreCompleto'),
                rol: formData.get('rol'),
                password: password || null,
                assemblyai_key: formData.get('apiKey') || null
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showUserResult('success', '¬°Usuario Actualizado Exitosamente!', 'Los cambios del usuario han sido guardados correctamente.');
            document.getElementById('userForm').reset();
            cargarUsuarios();
            
            // Restaurar bot√≥n original
            const submitBtn = document.querySelector('#userForm button[type="submit"]');
            submitBtn.innerHTML = '<i class="fas fa-user-plus me-1"></i>Crear Usuario';
            submitBtn.onclick = null;
        } else {
            showUserResult('error', 'Error al Actualizar Usuario', data.error);
        }
    } catch (error) {
        showUserResult('error', 'Error de Conexi√≥n', 'No se pudo conectar con el servidor: ' + error.message);
    }
}

async function cambiarEstado(id) {
    try {
        const response = await fetch(`/api/admin/users/${id}/toggle-status`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showUserResult('success', '¬°Estado Cambiado Exitosamente!', 'El estado del usuario ha sido actualizado correctamente.');
            cargarUsuarios();
        } else {
            showUserResult('error', 'Error al Cambiar Estado', data.error);
        }
    } catch (error) {
        showUserResult('error', 'Error de Conexi√≥n', 'No se pudo conectar con el servidor: ' + error.message);
    }
}

async function eliminarUsuario(id) {
    if (!confirm('¬øEst√°s seguro de que quieres eliminar este usuario? Esta acci√≥n no se puede deshacer.')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/eliminar-usuario/${id}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showUserResult('success', '¬°Usuario Eliminado Exitosamente!', 'El usuario ha sido eliminado correctamente del sistema.');
            cargarUsuarios();
        } else {
            showUserResult('error', 'Error al Eliminar Usuario', data.error);
        }
    } catch (error) {
        showUserResult('error', 'Error de Conexi√≥n', 'No se pudo conectar con el servidor: ' + error.message);
    }
}

async function actualizarEstadisticas() {
    try {
        const response = await fetch('/api/estadisticas');
        const data = await response.json();
        
        if (data.success) {
            // Verificar que los elementos existen antes de actualizarlos
            const totalCasosEl = document.getElementById('totalCasos');
            const casosActivosEl = document.getElementById('casosActivos');
            const casosCompletadosEl = document.getElementById('casosCompletados');
            
            if (totalCasosEl) totalCasosEl.textContent = data.stats.total_casos;
            if (casosActivosEl) casosActivosEl.textContent = data.stats.casos_activos;
            if (casosCompletadosEl) casosCompletadosEl.textContent = data.stats.casos_completados;
        } else {
            console.error('Error al cargar estad√≠sticas:', data.error);
        }
    } catch (error) {
        console.error('Error al cargar estad√≠sticas:', error.message);
    }
}

async function actualizarEstadisticasAvanzadas() {
    try {
        console.log(`üìä Cargando estad√≠sticas para ${currentYear}-${currentMonth}`);
        const response = await fetch(`/api/estadisticas-avanzadas?year=${currentYear}&month=${currentMonth}`);
        console.log('üì° Respuesta estad√≠sticas:', response.status);
        
        const data = await response.json();
        console.log('üìà Datos estad√≠sticas:', data);
        
        if (data.success) {
            // Actualizar estad√≠sticas generales del mes
            document.getElementById('totalCasosMes').textContent = data.estadisticas_mes.total_casos;
            document.getElementById('casosActivosMes').textContent = data.estadisticas_mes.casos_activos;
            document.getElementById('casosCompletadosMes').textContent = data.estadisticas_mes.casos_completados;
            document.getElementById('porcentajeCompletado').textContent = data.estadisticas_mes.porcentaje_completado + '%';
            
            // Actualizar mes actual
            const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                          'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            document.getElementById('mesActual').textContent = `${meses[currentMonth - 1]} ${currentYear}`;
            
            // Actualizar tabla de tipos de requerimiento
            mostrarTiposRequerimiento(data.por_tipo_requerimiento);
            
            // Actualizar tabla de or√≠genes de solicitud
            mostrarOrigenesSolicitud(data.por_origen_solicitud);
            
            // Actualizar gr√°fico hist√≥rico
            actualizarGraficoHistorico(data.historico);
            
        } else {
            console.error('Error al cargar estad√≠sticas avanzadas:', data.error);
        }
    } catch (error) {
        console.error('Error al cargar estad√≠sticas avanzadas:', error.message);
    }
}

function mostrarTiposRequerimiento(tipos) {
    const container = document.getElementById('tiposRequerimiento');
    
    if (tipos.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">No hay datos para este mes</p>';
        return;
    }
    
    let html = '<table class="table table-sm">';
    html += '<thead><tr><th>Tipo</th><th>Total</th><th>Completados</th><th>Activos</th><th>%</th></tr></thead>';
    html += '<tbody>';
    
    tipos.forEach(tipo => {
        html += `
            <tr>
                <td><small>${tipo.tipo}</small></td>
                <td><span class="badge bg-primary">${tipo.total}</span></td>
                <td><span class="badge bg-success">${tipo.completados}</span></td>
                <td><span class="badge bg-warning">${tipo.activos}</span></td>
                <td><span class="badge bg-info">${tipo.porcentaje_completado}%</span></td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
}

function mostrarOrigenesSolicitud(origenes) {
    const container = document.getElementById('origenesSolicitud');
    
    if (origenes.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">No hay datos para este mes</p>';
        return;
    }
    
    let html = '<table class="table table-sm">';
    html += '<thead><tr><th>Origen</th><th>Total</th><th>Completados</th><th>Activos</th><th>%</th></tr></thead>';
    html += '<tbody>';
    
    origenes.forEach(origen => {
        html += `
            <tr>
                <td><small>${origen.origen}</small></td>
                <td><span class="badge bg-primary">${origen.total}</span></td>
                <td><span class="badge bg-success">${origen.completados}</span></td>
                <td><span class="badge bg-warning">${origen.activos}</span></td>
                <td><span class="badge bg-info">${origen.porcentaje_completado}%</span></td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
}

function actualizarGraficoHistorico(historico) {
    const canvas = document.getElementById('graficoHistorico');
    const ctx = canvas.getContext('2d');
    
    // Limpiar canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    if (historico.length === 0) {
        ctx.fillStyle = '#666';
        ctx.font = '14px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('No hay datos hist√≥ricos disponibles', canvas.width / 2, canvas.height / 2);
        return;
    }
    
    // Configuraci√≥n del gr√°fico
    const padding = 40;
    const chartWidth = canvas.width - 2 * padding;
    const chartHeight = canvas.height - 2 * padding;
    const maxValue = Math.max(...historico.map(h => h.total));
    
    // Dibujar ejes
    ctx.strokeStyle = '#ddd';
    ctx.lineWidth = 1;
    
    // Eje Y
    ctx.beginPath();
    ctx.moveTo(padding, padding);
    ctx.lineTo(padding, canvas.height - padding);
    ctx.stroke();
    
    // Eje X
    ctx.beginPath();
    ctx.moveTo(padding, canvas.height - padding);
    ctx.lineTo(canvas.width - padding, canvas.height - padding);
    ctx.stroke();
    
    // Dibujar l√≠neas de datos
    const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
    
    // L√≠nea de totales
    ctx.strokeStyle = '#007bff';
    ctx.lineWidth = 2;
    ctx.beginPath();
    
    historico.forEach((h, index) => {
        const x = padding + (index * chartWidth / (historico.length - 1));
        const y = canvas.height - padding - (h.total * chartHeight / maxValue);
        
        if (index === 0) {
            ctx.moveTo(x, y);
        } else {
            ctx.lineTo(x, y);
        }
    });
    ctx.stroke();
    
    // L√≠nea de completados
    ctx.strokeStyle = '#28a745';
    ctx.lineWidth = 2;
    ctx.beginPath();
    
    historico.forEach((h, index) => {
        const x = padding + (index * chartWidth / (historico.length - 1));
        const y = canvas.height - padding - (h.completados * chartHeight / maxValue);
        
        if (index === 0) {
            ctx.moveTo(x, y);
        } else {
            ctx.lineTo(x, y);
        }
    });
    ctx.stroke();
    
    // Etiquetas de meses
    ctx.fillStyle = '#666';
    ctx.font = '10px Arial';
    ctx.textAlign = 'center';
    
    historico.forEach((h, index) => {
        const x = padding + (index * chartWidth / (historico.length - 1));
        ctx.fillText(meses[h.mes - 1], x, canvas.height - padding + 15);
    });
}

function cambiarMes(direccion) {
    currentMonth += direccion;
    
    if (currentMonth > 12) {
        currentMonth = 1;
        currentYear++;
    } else if (currentMonth < 1) {
        currentMonth = 12;
        currentYear--;
    }
    
    actualizarEstadisticasAvanzadas();
}

function exportarEstadisticas() {
    const url = `/api/estadisticas/exportar?year=${currentYear}&month=${currentMonth}`;
    window.open(url, '_blank');
}

async function debugCasos() {
    try {
        console.log('üîç Iniciando debug de casos...');
        console.log('üåê URL de debug:', '/api/debug-casos');
        
        const response = await fetch('/api/debug-casos');
        console.log('üì° Respuesta HTTP:', response.status, response.statusText);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('üìä Datos recibidos:', data);
        
        if (data.success) {
            const casosInfo = data.ultimos_casos.map(c => 
                `ID: ${c.id} - ${c.expediente} - ${c.numero_informe_tecnico} - Usuario: ${c.usuario_id} - Fecha: ${c.fecha_creacion}`
            ).join('\n');
            
            alert(`Debug de Casos:\n\nTotal de casos en BD: ${data.total_casos}\n\n√öltimos 5 casos:\n${casosInfo}`);
        } else {
            console.error('‚ùå Error en respuesta:', data.error);
            alert('Error en debug: ' + data.error);
        }
    } catch (error) {
        console.error('‚ùå Error en debug:', error);
        console.error('‚ùå Stack trace:', error.stack);
        alert('Error de conexi√≥n: ' + error.message);
    }
}

async function crearBackup() {
    try {
        const response = await fetch('/api/admin/backup', { method: 'POST' });
        const data = await response.json();
        
        if (data.success) {
            alert('Backup creado exitosamente: ' + data.filename);
        } else {
            alert('Error al crear backup: ' + data.error);
        }
    } catch (error) {
        alert('Error al crear backup: ' + error.message);
    }
}

async function limpiarDatos() {
    if (!confirm('¬øEst√°s seguro de que quieres limpiar datos antiguos? Esta acci√≥n no se puede deshacer.')) {
        return;
    }
    
    try {
        const response = await fetch('/api/admin/clear-old-data', { method: 'POST' });
        const data = await response.json();
        
        if (data.success) {
            alert('Datos antiguos limpiados exitosamente: ' + data.message);
            actualizarEstadisticas();
        } else {
            alert('Error al limpiar datos: ' + data.error);
        }
    } catch (error) {
        alert('Error al limpiar datos: ' + error.message);
    }
}

async function actualizarLogs() {
    try {
        const response = await fetch('/api/logs');
        const data = await response.json();
        
        if (data.success) {
            // Mostrar logs en la consola por ahora
            console.log('Logs actualizados:', data.logs);
            alert('Logs actualizados correctamente');
        } else {
            alert('Error al cargar logs: ' + data.error);
        }
    } catch (error) {
        alert('Error al cargar logs: ' + error.message);
    }
}

function exportarLogs() {
    alert('Funci√≥n de exportar logs en desarrollo');
}

// Funciones para cerrar modales
function closeViewModal() {
    document.getElementById('viewCaseModal').style.display = 'none';
}

function closeEditCaseModal() {
    document.getElementById('editCaseModal').style.display = 'none';
}

// Event listener para el formulario de edici√≥n de casos
document.getElementById('editCaseForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const caseId = formData.get('id');
    
    try {
        const response = await fetch(`/api/admin/update-case/${caseId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                expediente: formData.get('expediente'),
                nombre_caso: formData.get('nombre_caso'),
                numero_informe_tecnico: formData.get('numero_informe_tecnico'),
                estado_caso: formData.get('estado_caso'),
                fecha_intervencion: formData.get('fecha_intervencion'),
                hora_intervencion: formData.get('hora_intervencion'),
                origen_solicitud: formData.get('origen_solicitud'),
                tipo_requerimiento: formData.get('tipo_requerimiento'),
                observaciones: formData.get('observaciones')
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('Caso actualizado exitosamente');
            closeEditCaseModal();
            cargarCasos();
        } else {
            alert('Error al actualizar caso: ' + data.error);
        }
    } catch (error) {
        alert('Error al actualizar caso: ' + error.message);
    }
});

// Cerrar modal al hacer clic en X o fuera del modal
window.onclick = function(event) {
    const viewCaseModal = document.getElementById('viewCaseModal');
    const editCaseModal = document.getElementById('editCaseModal');
    const deleteConfirmModal = document.getElementById('deleteConfirmModal');
    const deleteResultModal = document.getElementById('deleteResultModal');
    const userResultModal = document.getElementById('userResultModal');
    
    if (event.target === viewCaseModal) {
        closeViewModal();
    } else if (event.target === editCaseModal) {
        closeEditCaseModal();
    } else if (event.target === deleteConfirmModal) {
        closeDeleteModal();
    } else if (event.target === deleteResultModal) {
        closeResultModal();
    } else if (event.target === userResultModal) {
        closeUserResultModal();
    }
}
</script>

<style>
.stats-item {
    padding: 1rem;
    border-radius: 8px;
    background: #f8f9fa;
    text-align: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    transition: transform 0.3s ease;
}

.stats-item:hover {
    transform: translateY(-2px);
}

.stats-item.bg-primary {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: white;
}

.stats-item.bg-success {
    background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
    color: white;
}

.stats-item.bg-warning {
    background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
    color: white;
}

.stats-item.bg-info {
    background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
    color: white;
}

.stats-number {
    font-size: 2rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
}

.table-sm th, .table-sm td {
    padding: 0.5rem;
    font-size: 0.875rem;
}

.badge {
    font-size: 0.75rem;
}

#graficoHistorico {
    max-width: 100%;
    height: 200px;
}

.stats-label {
    font-size: 0.9rem;
    color: #666;
}

.log-entry {
    padding: 0.5rem;
    border-bottom: 1px solid #eee;
    font-size: 0.9rem;
}

.fade-in-up {
    animation: fadeInUp 0.6s ease-out;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Estilos para modales */
.modal {
    position: fixed;
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    display: flex;
    justify-content: center;
    align-items: center;
}

.modal-content {
    background-color: #fefefe;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
    z-index: 10000;
    margin: 20px;
    max-width: 90vw;
}

.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    position: absolute;
    top: 10px;
    right: 15px;
}

.close:hover,
.close:focus {
    color: black;
    text-decoration: none;
}

.case-detail-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.detail-section {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    border-left: 4px solid #007bff;
}

.detail-section h4 {
    margin-bottom: 15px;
    color: #333;
    font-size: 1.1em;
}

.detail-section p {
    margin-bottom: 8px;
    line-height: 1.4;
}

.form-row {
    display: flex;
    gap: 15px;
    margin-bottom: 15px;
}

.form-group {
    flex: 1;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
    color: #333;
}

.form-group input,
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.form-group textarea {
    resize: vertical;
    min-height: 80px;
}

.form-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #eee;
}

/* Asegurar que el modal est√© por encima de todo */
.modal {
    z-index: 99999 !important;
}

.modal-content {
    z-index: 100000 !important;
    position: relative;
}

/* Asegurar que el fondo del modal cubra toda la pantalla */
.modal::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background-color: rgba(0,0,0,0.5);
    z-index: -1;
}

/* Centrar modales */
.modal-centered {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    max-width: 800px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
}

/* Modal peque√±o para confirmaciones */
.modal-small {
    max-width: 500px;
    width: 90%;
}

/* Estilos para el modal de confirmaci√≥n de eliminaci√≥n */
.delete-modal-header {
    text-align: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #dc3545;
}

.delete-modal-header i {
    font-size: 3rem;
    color: #dc3545;
    margin-bottom: 10px;
    display: block;
}

.delete-modal-header h2 {
    color: #dc3545;
    margin: 0;
    font-size: 1.5rem;
}

.delete-modal-body {
    text-align: center;
    margin-bottom: 25px;
}

.delete-modal-body p {
    font-size: 1.1rem;
    margin-bottom: 15px;
    color: #333;
}

.case-info {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
    margin: 15px 0;
    text-align: left;
}

.case-summary p {
    margin: 5px 0;
    font-size: 0.95rem;
}

.warning-text {
    color: #dc3545 !important;
    font-weight: bold;
    font-size: 0.9rem !important;
    margin-top: 15px !important;
}

.delete-modal-actions {
    display: flex;
    gap: 15px;
    justify-content: center;
    margin-top: 25px;
    padding-top: 20px;
    border-top: 1px solid #dee2e6;
}

.delete-modal-actions .btn {
    min-width: 150px;
    padding: 10px 20px;
    font-weight: 500;
}

.delete-modal-actions .btn-danger {
    background-color: #dc3545;
    border-color: #dc3545;
}

.delete-modal-actions .btn-danger:hover {
    background-color: #c82333;
    border-color: #bd2130;
}

/* Estilos para el modal de resultado */
.result-modal-header {
    text-align: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #28a745;
}

.result-modal-header i {
    font-size: 3rem;
    margin-bottom: 10px;
    display: block;
}

.result-modal-header h2 {
    margin: 0;
    font-size: 1.5rem;
}

.success-header {
    border-bottom-color: #28a745;
}

.success-header i {
    color: #28a745;
}

.success-header h2 {
    color: #28a745;
}

.error-header {
    border-bottom-color: #dc3545;
}

.error-header i {
    color: #dc3545;
}

.error-header h2 {
    color: #dc3545;
}

.result-modal-body {
    text-align: center;
    margin-bottom: 25px;
}

.result-modal-body p {
    font-size: 1.1rem;
    color: #333;
    line-height: 1.5;
}

.result-modal-actions {
    display: flex;
    justify-content: center;
    margin-top: 25px;
    padding-top: 20px;
    border-top: 1px solid #dee2e6;
}

.result-modal-actions .btn {
    min-width: 150px;
    padding: 12px 25px;
    font-weight: 500;
    font-size: 1rem;
}

.result-modal-actions .btn-primary {
    background-color: #007bff;
    border-color: #007bff;
}

.result-modal-actions .btn-primary:hover {
    background-color: #0056b3;
    border-color: #004085;
}

/* Responsive para modales */
@media (max-width: 768px) {
    .modal-centered {
        width: 95%;
        max-width: none;
        margin: 10px;
    }
    
    .delete-modal-actions {
        flex-direction: column;
    }
    
    .delete-modal-actions .btn {
        width: 100%;
    }
    
    .result-modal-actions .btn {
        width: 100%;
    }
}
</style>
{% endblock %}
